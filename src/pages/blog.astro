---
import Layout from '../layouts/Layout.astro';
import NotionRenderer from '../components/Glaze/NotionRenderer.astro';
import { fetchStrapi } from "../utils/strapi";

// 1. [ì„¤ì •] Strapi ì£¼ì†Œ ê°€ì ¸ì˜¤ê¸° (ì´ë¯¸ì§€ ê²½ë¡œ ë³´ì •ìš©)
const STRAPI_URL = import.meta.env.STRAPI_URL || "https://strapi.humanerd.kr";

// 2. ë¸”ë¡œê·¸ ì†Œê°œ ì •ë³´ ê°€ì ¸ì˜¤ê¸° (Notionì—ì„œ slugê°€ 'blog'ì¸ í˜ì´ì§€)
const blogInfoData = await fetchStrapi('single-pages?filters[Slug][$eq]=blog&populate=*');
const blogInfo = blogInfoData?.[0];

// 3. ê²Œì‹œê¸€ ëª©ë¡ ê°€ì ¸ì˜¤ê¸° (ìµœì‹ ìˆœ)
// populate=* ë¥¼ í•´ì•¼ Cover ì´ë¯¸ì§€ê°€ ë”°ë¼ì˜µë‹ˆë‹¤.
const posts = await fetchStrapi('post-pages?populate=*&sort=publishedAt:desc');

// 4. [í•µì‹¬] ì¸ë„¤ì¼ ì´ë¯¸ì§€ ì£¼ì†Œ ì¶”ì¶œ ë° ë³´ì • í•¨ìˆ˜
const getCoverImage = (post: any) => {
  if (!post) return null;
  const cover = post.Cover;
  if (!cover) return null;

  let imageUrl = null;
  
  // (A) Notion ì›ë³¸ ë°ì´í„° (External or File)
  if (cover.type === 'external') imageUrl = cover.external?.url;
  else if (cover.type === 'file') imageUrl = cover.file?.url;
  
  // (B) Strapi ë¯¸ë””ì–´ í•„ë“œ
  else if (cover.url) imageUrl = cover.url;
  else if (cover.data?.attributes?.url) imageUrl = cover.data.attributes.url;

  // 5. [ì¤‘ìš”] ìƒëŒ€ ê²½ë¡œ(/uploads/...)ì¸ ê²½ìš° ë„ë©”ì¸ ë¶™ì—¬ì£¼ê¸°
  if (imageUrl && imageUrl.startsWith('/')) {
    return `${STRAPI_URL}${imageUrl}`;
  }

  return imageUrl;
};
---

<Layout title={blogInfo ? blogInfo.Title : "Insight Archive"}>
  <main class="max-w-6xl mx-auto px-6 py-12 md:py-20">
    
    {/* íˆì–´ë¡œ ì„¹ì…˜ (ë¸”ë¡œê·¸ ì œëª© & ì†Œê°œ) */}
    <div class="text-center mb-20">
      <h1 class="text-5xl md:text-7xl font-black text-slate-900 tracking-tight mb-6">
        {blogInfo ? (
            blogInfo.Title
        ) : (
            <span>Insight <span class="text-primary">Archive</span></span>
        )}
      </h1>
      
      <div class="text-xl text-slate-500 max-w-2xl mx-auto font-medium leading-relaxed notion-renderer">
        {blogInfo && blogInfo.Content ? (
            <NotionRenderer blocks={blogInfo.Content} />
        ) : (
            <p>Notionì— [Slug: blog] í˜ì´ì§€ë¥¼ ë§Œë“¤ë©´ ì´ê³³ì— ì†Œê°œê¸€ì´ ë‚˜íƒ€ë‚©ë‹ˆë‹¤.</p>
        )}
      </div>
    </div>

    {/* ê²Œì‹œê¸€ ê·¸ë¦¬ë“œ */}
    {posts && posts.length > 0 ? (
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
        {posts.map((post: any) => {
          const coverUrl = getCoverImage(post);
          
          return (
            <article class="group bg-white rounded-3xl overflow-hidden border border-slate-100 hover:shadow-xl hover:-translate-y-1 transition-all duration-300 flex flex-col h-full">
              
              {/* ì´ë¯¸ì§€ ì˜ì—­ (ë§í¬ í¬í•¨) */}
              <a href={`/post/${post.Slug}`} class="block overflow-hidden aspect-[1.5] relative bg-slate-100">
                 {coverUrl ? (
                    // âœ… ì´ë¯¸ì§€ê°€ ìˆì„ ë•Œ: ê½‰ ì°¨ê²Œ ë Œë”ë§
                    <img 
                      src={coverUrl} 
                      alt={post.Title} 
                      class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-105"
                      loading="lazy" 
                    />
                 ) : (
                    // âŒ ì´ë¯¸ì§€ê°€ ì—†ì„ ë•Œ: ëŒ€ì²´ ì•„ì´ì½˜ í‘œì‹œ
                    <div class="w-full h-full flex items-center justify-center text-slate-300 bg-slate-50">
                       <span class="text-4xl group-hover:scale-110 transition-transform duration-300">ğŸ“</span>
                    </div>
                 )}
                 {/* í˜¸ë²„ ì‹œ ì‚´ì§ ì–´ë‘ì›Œì§€ëŠ” íš¨ê³¼ */}
                 <div class="absolute inset-0 bg-black/0 group-hover:bg-black/5 transition-colors duration-300"></div>
              </a>

              {/* í…ìŠ¤íŠ¸ ì˜ì—­ */}
              <div class="p-6 flex flex-col flex-1">
                <div class="flex items-center gap-3 mb-3">
                   {/* ë‚ ì§œ */}
                   <span class="text-xs font-bold text-primary bg-primary/5 px-2 py-1 rounded">
                     {new Date(post.publishedAt).toLocaleDateString()}
                   </span>
                   {/* íƒœê·¸ (ì²« ë²ˆì§¸ë§Œ í‘œì‹œ) */}
                   {post.Tags && post.Tags.length > 0 && (
                     <span class="text-xs text-slate-400">#{post.Tags[0]}</span>
                   )}
                </div>
               
                <h2 class="text-xl font-bold text-slate-900 mb-3 leading-snug group-hover:text-primary transition-colors">
                  <a href={`/post/${post.Slug}`}>
                    {post.Title}
                  </a>
                </h2>

                <p class="text-slate-500 text-sm line-clamp-2 mb-4 flex-1 leading-relaxed">
                  {post.Excerpt || "í´ë¦­í•˜ì—¬ ë‚´ìš©ì„ í™•ì¸í•˜ì„¸ìš”."}
                </p>
                
                <a href={`/post/${post.Slug}`} class="inline-flex items-center text-sm font-bold text-slate-900 hover:text-primary transition-colors mt-auto group/link">
                  Read Article 
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 ml-1 transition-transform group-hover/link:translate-x-1" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M12.293 5.293a1 1 0 011.414 0l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414-1.414L14.586 11H3a1 1 0 110-2h11.586l-2.293-2.293a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                </a>
              </div>
            </article>
          );
        })}
      </div>
    ) : (
      // ê²Œì‹œë¬¼ì´ ì—†ì„ ë•Œ
      <div class="text-center py-20 bg-slate-50 rounded-3xl border border-dashed border-slate-200">
        <p class="text-slate-500 mb-2">ì•„ì§ ê²Œì‹œë¬¼ì´ ì—†ìŠµë‹ˆë‹¤.</p>
        <p class="text-xs text-slate-400">(Strapi 'post-pages' ì»¬ë ‰ì…˜ì„ í™•ì¸í•´ì£¼ì„¸ìš”)</p>
      </div>
    )}

  </main>
</Layout>
