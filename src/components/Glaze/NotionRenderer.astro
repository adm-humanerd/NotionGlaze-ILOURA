---
import { slugify } from "../../utils/slugify";
import RecursiveBlock from './NotionRenderer.astro';
import NotionGallery from './NotionGallery.astro';

interface Props {
  blocks: any[];
}

const { blocks } = Astro.props;

// ğŸ¨ [ìƒ‰ìƒ ë²ˆì—­ê¸°] Notion ìƒ‰ìƒ -> Tailwind í´ë˜ìŠ¤ ë§¤í•‘
const colorMap: Record<string, { text: string; bg: string }> = {
  default: { text: "text-slate-700", bg: "bg-white" },
  gray:    { text: "text-slate-500", bg: "bg-slate-100" },
  brown:   { text: "text-amber-700", bg: "bg-amber-100" },
  orange:  { text: "text-orange-600", bg: "bg-orange-50" },
  yellow:  { text: "text-yellow-600", bg: "bg-yellow-50" },
  green:   { text: "text-emerald-600", bg: "bg-emerald-50" },
  blue:    { text: "text-blue-600",   bg: "bg-blue-50" },
  purple:  { text: "text-purple-600", bg: "bg-purple-50" },
  pink:    { text: "text-pink-600",   bg: "bg-pink-50" },
  red:     { text: "text-red-600",    bg: "bg-red-50" },
};

// ìƒ‰ìƒ í´ë˜ìŠ¤ ì¶”ì¶œ í•¨ìˆ˜
const getColorClass = (colorName: string, type: 'text' | 'bg' = 'text') => {
  if (!colorName || colorName === 'default') return "";
  
  // ë°°ê²½ìƒ‰ì¸ ê²½ìš° (ì˜ˆ: "blue_background")
  if (colorName.endsWith('_background')) {
    const baseColor = colorName.replace('_background', '');
    return colorMap[baseColor] ? colorMap[baseColor].bg : "";
  }
  
  // ê¸€ììƒ‰ì¸ ê²½ìš° (ì˜ˆ: "blue")
  return colorMap[colorName] ? colorMap[colorName].text : "";
};

// í—¬í¼ í•¨ìˆ˜: ë‹¤ì–‘í•œ êµ¬ì¡°ì—ì„œ ì•ˆì „í•˜ê²Œ URL ì¶”ì¶œ ë° Strapi ì£¼ì†Œ ë³´ì •
const resolveImageUrl = (imgObj: any) => {
  if (!imgObj) return null;
  
  let url = null;

  // 1. Strapi ë¯¸ë””ì–´ ë°ì´í„° (attributes êµ¬ì¡°)
  if (imgObj.data?.attributes?.url) {
      url = imgObj.data.attributes.url;
  } 
  // 2. Strapi ë¯¸ë””ì–´ ë°ì´í„° (ì§ì ‘ url êµ¬ì¡°)
  else if (imgObj.data?.url) {
      url = imgObj.data.url;
  }
  // 3. Notion ë¸”ë¡ êµ¬ì¡° ë‚´ì—ì„œ Strapi URLì´ ì´ë¯¸ ì¹˜í™˜ë˜ì—ˆëŠ”ì§€ í™•ì¸ (file/external)
  else if (imgObj.file?.url) {
      url = imgObj.file.url;
  }
  else if (imgObj.external?.url) {
      url = imgObj.external.url;
  }
  // 4. ì»¤ìŠ¤í…€ í•„ë“œë¡œ ì €ì¥ëœ URL (ë¬¸ìì—´)
  else if (typeof imgObj.url === 'string') {
      url = imgObj.url;
  }

  if (!url || typeof url !== 'string') return null;

  // [í•µì‹¬] Strapi ì„œë²„ ì£¼ì†Œ ë³´ì • ë° ìƒëŒ€ ê²½ë¡œ ì²˜ë¦¬
  // 1. ìƒëŒ€ ê²½ë¡œì¸ ê²½ìš° Strapi URL ë¶™ì—¬ì¤Œ
  if (url.startsWith('/uploads/')) {
      url = `https://strapi.iloura.co.kr${url}`;
  } 
  // 2. êµ¬ë²„ì „ ë„ë©”ì¸ì¸ ê²½ìš° ì‹ ê·œ ë„ë©”ì¸ìœ¼ë¡œ ì¹˜í™˜
  else if (url.includes('strapi.humanerd.kr')) {
      url = url.replace('strapi.humanerd.kr', 'strapi.iloura.co.kr');
  }
  
  return url;
};

// ğŸ”„ [ì „ì²˜ë¦¬] ë¸”ë¡ ê·¸ë£¹í™”
const processBlocks = (rawBlocks: any[]) => {
  if (!rawBlocks || !Array.isArray(rawBlocks)) return [];
  const processed = [];
  let listGroup: any = null;

  for (const block of rawBlocks) {
    const isNum = block.type === 'numbered_list_item';
    const isBul = block.type === 'bulleted_list_item';

    if (isNum || isBul) {
      const groupType = isNum ? 'numbered_list_group' : 'bulleted_list_group';
      if (!listGroup || listGroup.type !== groupType) {
        listGroup = { type: groupType, items: [] };
        processed.push(listGroup);
      }
      listGroup.items.push(block);
    } else {
      listGroup = null;
      processed.push(block);
    }
  }
  return processed;
};

const modifiedBlocks = processBlocks(blocks);

// âœï¸ [Rich Text ë Œë”ë§] ìƒ‰ìƒ ì ìš© ë¡œì§ ì¶”ê°€
const renderRichText = (richTextArray: any[]) => {
  if (!Array.isArray(richTextArray)) return "";
  return richTextArray.map((t) => {
    const content = t.plain_text || t.text?.content || "";
    let styled = content;
    const anno = t.annotations || {};

    // 1. ê¸°ë³¸ ìŠ¤íƒ€ì¼
    if (anno.bold) styled = `<strong>${styled}</strong>`;
    if (anno.italic) styled = `<em>${styled}</em>`;
    if (anno.strikethrough) styled = `<del>${styled}</del>`;
    if (anno.code) styled = `<code class="bg-slate-100 text-slate-600 px-1 rounded font-mono text-sm border border-slate-200">${styled}</code>`;
    
    // 2. [í•µì‹¬] ê¸€ì ìƒ‰ìƒ ë° ë°°ê²½ ìƒ‰ìƒ ì ìš©
    if (anno.color && anno.color !== 'default') {
      const colorClass = getColorClass(anno.color, anno.color.endsWith('_background') ? 'bg' : 'text');
      const extraStyle = anno.color.endsWith('_background') ? 'px-1 rounded' : '';
      styled = `<span class="${colorClass} ${extraStyle}">${styled}</span>`;
    }
    
    // 3. ë§í¬
    if (t.href) styled = `<a href="${t.href}" target="_blank" class="text-primary hover:underline transition-colors">${styled}</a>`;
    
    return styled;
  }).join('');
};

// í…ìŠ¤íŠ¸ ì¶”ì¶œ (ì•ˆì „ ëª¨ë“œ)
const getSafeText = (block: any) => {
  if (!block) return "";
  const type = block.type;
  const value = block[type];

  if (value) {
      const textData = value.text || value.rich_text; 
      if (Array.isArray(textData)) return renderRichText(textData);
      if (typeof value.text === 'string') return value.text;
  }
  
  if (block.text && Array.isArray(block.text)) return renderRichText(block.text);
  if (block.rich_text && Array.isArray(block.rich_text)) return renderRichText(block.rich_text);

  return ""; 
};
---

{modifiedBlocks.map((block: any) => {
  const type = block.type;
  const value = block[type] || {}; 
  const htmlContent = getSafeText(block);
  
  // children ë°ì´í„° ì¶”ì¶œ ë¡œì§ ê°•í™”: block.children, value.children, ë˜ëŠ” block[type].children ëŒ€ì‘
  const childrenData = block.children || value.children || block[type]?.children || []; 

  switch (type) {
    case 'numbered_list_group':
      return (
        <ol class="list-decimal list-outside ml-5 space-y-1 my-4 text-slate-700">
          {block.items.map((item: any) => {
            const itemChildren = item.children || item[item.type]?.children || [];
            return (
              <li class="pl-2 leading-relaxed">
                <span set:html={getSafeText(item)}></span>
                {itemChildren.length > 0 && (
                  <div class="mt-2 ml-4">
                    <RecursiveBlock blocks={itemChildren} />
                  </div>
                )}
              </li>
            );
          })}
        </ol>
      );

    case 'bulleted_list_group':
      return (
        <ul class="list-disc list-outside ml-5 space-y-1 my-4 text-slate-700 marker:text-primary">
          {block.items.map((item: any) => {
            const itemChildren = item.children || item[item.type]?.children || [];
            return (
              <li class="pl-2 leading-relaxed">
                <span set:html={getSafeText(item)}></span>
                {itemChildren.length > 0 && (
                  <div class="mt-2 ml-4">
                    <RecursiveBlock blocks={itemChildren} />
                  </div>
                )}
              </li>
            );
          })}
        </ul>
      );

    case 'paragraph':
       const pColorClass = value.color ? getColorClass(value.color, 'text') : ""; 
       if (!htmlContent && childrenData.length === 0) return <div class="h-2"></div>;
       return (
         <div class="mb-2">
           {htmlContent && <p class={`text-base md:text-lg leading-relaxed break-words ${pColorClass}`} set:html={htmlContent}></p>}
           {childrenData.length > 0 && (
             <div class="ml-6 mt-2">
               <RecursiveBlock blocks={childrenData} />
             </div>
           )}
         </div>
       );

    case 'heading_1':
    case 'heading_2':
    case 'heading_3':
      const Tag = type === 'heading_1' ? 'h2' : type === 'heading_2' ? 'h3' : 'h4';
      const headingClass = type === 'heading_1' 
        ? "scroll-mt-24 text-3xl md:text-4xl font-black mt-12 mb-6 text-slate-900" 
        : type === 'heading_2' 
          ? "scroll-mt-24 text-2xl md:text-3xl font-bold mt-10 mb-4 text-slate-800" 
          : "scroll-mt-24 text-xl md:text-2xl font-bold mt-8 mb-3 text-slate-800";
      
      return (
        <div class="group heading-wrapper">
          <Tag id={slugify(htmlContent.replace(/<[^>]*>/g, ''))} class={headingClass} set:html={htmlContent}></Tag>
          {childrenData.length > 0 && (
            <div class="ml-6 mb-4">
              <RecursiveBlock blocks={childrenData} />
            </div>
          )}
        </div>
      );

    case 'divider':
      return <hr class="my-8 border-t-2 border-slate-100" />;

    case 'quote':
      return (
          <blockquote class="border-l-4 border-primary pl-5 py-3 my-8 bg-slate-50 rounded-r-lg italic text-slate-600 text-lg">
             <div set:html={htmlContent}></div>
             {childrenData && childrenData.length > 0 && (
                <div class="mt-4 not-italic">
                   <RecursiveBlock blocks={childrenData} />
                </div>
             )}
          </blockquote>
      );

    case 'callout':
      const iconData = value.icon || block.icon;
      let IconEl = null;
      
      const calloutColor = value.color;
      let bgClass = "bg-slate-50 border-slate-200/60"; 
      
      if (calloutColor && calloutColor !== 'default') {
          const mappedBg = getColorClass(calloutColor, 'bg');
          if (mappedBg) bgClass = `${mappedBg} border-transparent`;
      }

      if (iconData) {
        if (typeof iconData === 'string') { 
           IconEl = <span class="text-2xl mr-4 select-none">{iconData}</span>;
        } else if (iconData.emoji) {
           IconEl = <span class="text-2xl mr-4 select-none">{iconData.emoji}</span>;
        } else {
           const iconUrl = resolveImageUrl(iconData);
           if (iconUrl) {
             IconEl = <img src={iconUrl} class="w-6 h-6 mr-4 object-contain" alt="icon" />;
           }
        }
      }

      return (
          <div class={`flex items-start p-5 my-6 rounded-xl border shadow-sm ${bgClass}`}>
              {IconEl}
              <div class="flex-1 min-w-0">
                  {htmlContent && (
                    <div class="text-slate-800 font-medium leading-relaxed mb-1" set:html={htmlContent}></div>
                  )}
                  {childrenData && childrenData.length > 0 && (
                      <div class="space-y-2 text-slate-700 mt-2">
                        <RecursiveBlock blocks={childrenData} />
                      </div>
                  )}
              </div>
          </div>
      );

    case 'column_list':
      if (!childrenData || childrenData.length === 0) return null;
      // [í•µì‹¬ ìˆ˜ì •] ìì‹ ê°œìˆ˜ì— ë”°ë¼ ê·¸ë¦¬ë“œ ì»¬ëŸ¼ ìˆ˜ ë™ì  ê²°ì •
      const colCount = childrenData.length;
      const gridColsClass = colCount === 2 ? "md:grid-cols-2" : colCount >= 3 ? "md:grid-cols-3" : "grid-cols-1";
      return (
          <div class={`grid grid-cols-1 ${gridColsClass} gap-6 w-full my-8`}>
              <RecursiveBlock blocks={childrenData} />
          </div>
      );

    case 'column':
      if (!childrenData || childrenData.length === 0) return null;
      return (
          <div class="flex flex-col gap-4 w-full">
              <RecursiveBlock blocks={childrenData} />
          </div>
      );

    case 'image':
      const imgValue = value.image || value;
      const imgUrl = resolveImageUrl(imgValue);
      
      if (!imgUrl) return null;
      const captionData = imgValue.caption;
      const caption = captionData ? (Array.isArray(captionData) ? captionData.map((c:any) => c.plain_text).join('') : "") : "";
      
      return (
          <figure class="my-10">
              <div class="rounded-2xl overflow-hidden border border-slate-100 shadow-sm">
                 <img src={imgUrl} alt={caption} class="w-full h-auto" loading="lazy" />
              </div>
              {caption && <figcaption class="text-center text-sm text-slate-500 mt-2">{caption}</figcaption>}
          </figure>
      );

    case 'bookmark':
      const bookmarkUrl = value.url;
      if (!bookmarkUrl) return null;
      return (
        <div class="my-6">
          <a href={bookmarkUrl} target="_blank" rel="noopener noreferrer" class="flex items-center p-4 rounded-lg border border-slate-200 bg-white hover:bg-slate-50 transition-colors no-underline">
             <div class="flex-1 min-w-0 pr-4">
                <p class="text-sm text-slate-500 truncate">{bookmarkUrl}</p>
             </div>
             <span class="text-slate-400">â†—</span>
          </a>
        </div>
      );

    case 'child_database':
      if (value.items && Array.isArray(value.items)) {
         return (
            <div class="my-10">
                <div class="flex items-center mb-4">
                    <span class="text-xl mr-2">ğŸ—‚ï¸</span>
                    <h3 class="font-bold text-slate-700 text-lg">{value.child_database?.title || value.title || "Gallery"}</h3>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    {value.items.map((item: any) => (
                        <div class="bg-white rounded-xl border border-slate-200 overflow-hidden shadow-sm hover:shadow-md transition-shadow">
                            <div class="h-40 bg-slate-100 overflow-hidden relative">
                                {item.cover ? (
                                    <img src={item.cover} alt={item.title} class="w-full h-full object-cover hover:scale-105 transition-transform duration-500" />
                                ) : (
                                    <div class="w-full h-full flex items-center justify-center text-3xl text-slate-300">ğŸ“„</div>
                                )}
                            </div>
                            <div class="p-4">
                                <h4 class="font-bold text-slate-800 text-sm truncate">{item.title}</h4>
                            </div>
                        </div>
                    ))}
                </div>
            </div>
         );
      }
      return <NotionGallery id={block.id} title={value.child_database?.title || value.title || "Gallery"} />;

    default:
      return null;
  }
})}
